PREFIX=	/usr/local
BINDIR=	$(PREFIX)/bin
MANDIR=	$(PREFIX)/share/man
INCDIR=	$(PREFIX)/include
LIBDIR=	$(PREFIX)/lib
BIN=	vddiff
OBJ=	main.o pars.o lex.o diff.o ui.o db.o exec.o fs.o ed.o

YFLAGS=	-d
_CFLAGS=$(CFLAGS) $(CPPFLAGS) $(DEFINES) $(INCDIR_CURSES) -I$(INCDIR) \
	$(__CDBG) $(__SAN) -Wall -Wextra
_LDFLAGS=$(LDFLAGS) $(__SAN) -L${LIBDIR} -Wl,-rpath,${LIBDIR} \
	#-s
LDADD=	-lavlbst $(LIBDIR_CURSES) $(LIB_CURSES)

$(BIN):	$(OBJ)
	$(CC) $(_CFLAGS) $(_LDFLAGS) $(RPATH_CURSES) -o $@ $(OBJ) $(LDADD)

install:
	[ -d $(BINDIR) ] || mkdir -p $(BINDIR)
	install $(BIN) $(BINDIR)/
	[ -d $(MANDIR)/man1 ] || mkdir -p $(MANDIR)/man1
	install -m 644 $(BIN).1 $(MANDIR)/man1/

clean:
	rm -f $(BIN) $(OBJ) y.tab.h $(BIN).1.html

distclean: clean
	rm -f Makefile config.log compat.h

.y.o:
	$(YACC) $(YFLAGS) $<
	$(CC) $(_CFLAGS) -c y.tab.c -o $@
	rm y.tab.c

.c.o:
	$(CC) $(_CFLAGS) -c $<

html:
	make $(BIN).1.html

$(BIN).1.html: $(BIN).1
	tbl $(BIN).1 | eqn | troff -Thtml -mandoc -dToc=/tmp/toc \
	    2> /tmp/err | dhtml -t "$(BIN)(1)" > $@
	sed -n 's/^Toc://p' /tmp/err > /tmp/toc
	tbl $(BIN).1 | eqn | troff -Thtml -mandoc -dToc=/tmp/toc \
	    2> /tmp/err | dhtml -t "$(BIN)(1)" > $@
	sed -n 's/^Toc://p' /tmp/err > /tmp/toc
	tbl $(BIN).1 | eqn | troff -Thtml -mandoc -dToc=/tmp/toc \
	    2> /tmp/err | dhtml -t "$(BIN)(1)" > $@

main.o: pars.o # y.tab.h
lex.o: pars.o # y.tab.h
