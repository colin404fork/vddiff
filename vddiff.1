.ig
Copyright (c) 2016, Carsten Kunze <carsten.kunze@arcor.de>

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
..
.Dd September 26, 2016
.Dt VDDIFF 1
.Sh NAME
.Nm vddiff
.Nd text terminal directory diff tool
.Sh SYNOPSYS
.Nm
.Op Fl u
.Op Fl bcdfgklmnrV
.Op Fl t Ar diff_tool
.Ar directory_1
.Ar directory_2
.Sh DESCRIPTION
.Nm
stands for
.Dq Vim Directory DIFF .
It is a simple text terminal directory diff tool using
.Xr vim 1
for the actual diff operation.
(If vim is not installed,
.Dq Li diff Ar file_1 Ar file_2 Li | less
is used instead.
Other diff tools can be configured as well.)
A file browser displays the names found in the directories
given on the command line.
Only plain files and symbolic links are compared.
Unless option
.Fl r
is used,
directories are not compared before they are entered.
.Pp
Compressed files are automatically decompressed into
a temporary directory before the diff tool is started.
These files are detected by their file name extension,
the file contents are not checked.
Currently the following file name extensions are
supported:
.Li bz2 ,
.Li gz ,
.Li tar ,
.Li tbz ,
.Li tgz ,
and
.Li zip .
.Pp
Symbols are printed in two columns before the names
which have the following meaning:
.Pp
First column: Difference type
.Bl -column -offset indent ".Sq Li !"
.It So Li " " Sc Ta "Directory, equal files or different file types"
.It So Li ! Sc Ta "Different files or links (or directories with option" Fl r )
.It So Li < Sc Ta "Files found in first directory only"
.It So Li > Sc Ta "Files found in second directory only"
.It So Li = Sc Ta "Files have same i-node"
.El
.Pp
Second column: File type
.Bl -column -offset indent ".Sq Li !"
.It So Li / Sc Ta Directory
.It So Li " " Sc Ta "Plain file"
.It So Li @ Sc Ta "Symbolic link"
.It So Li ? Sc Ta "Any other file type"
.It So Li ! Sc Ta "Different file type"
.El
.Sh OPTIONS
.Bl -tag
.It Fl B
Debug option.
(If
.Nm
is started with only one or no argument
it behaves like a simple single directory view
file browser.)
.It Fl b
Disable color.
.It Fl c
Show only directories which exist in both trees
and really different files.
.It Fl d
Use
.Dq Li diff $1 $2 | less
as diff tool.
.It Fl f
Normally directories are displayed on top.
With this option files are displayed first.
.It Fl g
Use
.Nm gvim
as diff and view tool.
.It Fl k
Use
.Nm tkdiff
as diff tool.
.It Fl l
Follow symbolic links.
(Note that the integrated file copy and delete operations
never follow symbolic links.)
.It Fl m
Normally directories are displayed on top.
This is disabled with this option.
.It Fl n
This option suppresses the display of equal files.
.It Fl r
Recursively scan directories to detect differences in subdirectories.
This allows to mark directories which contain differences.
It increases the start time (due to disk I/O) since
the full file tree is compared at begin.
To only show different directories this option needs to be
combined with
.Fl c .
Pressing key
.Sq c
enables to view all files in this mode.
.It Fl t Ar diff_tool
Specify diff tool on the command line.
The filenames to compare are appended to the given string.
To include them into the string the symbolic names
.Dq Li $1
and
.Dq Li $2
can be used (in any order), where
.Dq Li $1
refers to the first and
.Dq Li $2
to the second file.
Note that the shell may require quoting as in
.Pp
.Dl -t \(dqdiff \(rs$1 \(rs$2 | vim -R -\(dq
.Pp
Also note the quoting of the filenames itself.
When the symbolic names
.Li $ Ns Ar n
are used,
.Xr system 3
instead of
.Xr execvp 3
is used.
This applies restrictions on the characters used
in filenames.
.It Fl u Op Ar filename
Skip reading the initialization file at start-up.
If
.Fl u
is used, it must be the very first option.
If an optional
.Ar filename
is supplied, this file is read instead of the default
initialization file
.Pa ~/.vddiffrc .
.It Fl V
Print version and exit.
.It Fl v Ar view_tool
Specify view tool on the command line.
The filenames is appended to the given string.
To include it into the string the symbolic name
.Dq Li $1
can be embedded which is expanded to the filename.
.El
.Sh INTERACTIVE COMMANDS
.Bl -tag
.It Sq Li q
Quit.
.It So Li h Sc or Sq Li \&?
Display help.
.It Ao Cm UP Ac , So Li k Sc or Sq Li -
Move cursor line up.
.It Ao Cm DOWN Ac , So Li j Sc or Sq Li +
Move cursor line down.
.It Aq Cm LEFT
Leave directory (one directory up).
.It Ao Cm RIGHT Ac or Aq Cm ENTER
Enter directory or start diff tool.
Compressed files are unpacked before the diff tool is started
but compressed directories can only be viewed (the compressed
archives are compared instead).
.It Ao Cm PAGE-UP Ac or Aq Cm BACKSPACE
Scroll one screen up.
.It Ao Cm PAGE-DOWN Ac or Aq Cm SPACE
Scroll one screen down.
.It Ao Cm HOME Ac or Sq Li 1G
Go to first file.
.It Ao Cm END Ac or Sq Li G
Go to last file.
.It Sq Li /
Search file in list by typing the begin of the filename.
Searching is normally done case-insensitive.
Set option
.Cm noic
to change this.
.It Dq Li //
Search with a basic regular expression for a filename.
This can be configured with options
.Cm noic
(don't ignore case),
.Cm magic
(use extended regular expressions), and
.Cm nows
(don't wrap around when search hits top or bottom
of the file list).
.Pp
Previously entered search patterns are saved in a history,
which can be accessed with the
.Aq Cm UP
and
.Aq Cm DOWN
keys.
.It Sq Li S
Sort files by name only (ignoring file type).
.It Sq Li D
Sort files with directories on top.
.It Sq Li H
Put cursor to top line.
.It Sq Li M
Put cursor on middle line.
.It Sq Li L
Put cursor on bottom line.
.It Dq Li z Ns Aq Cm ENTER
Put selected file to top.
.It Dq Li z.
Center selected file.
.It Dq Li z-
Put selected file to bottom.
.It So Li ! Sc or Sq Li n
Toggle display of equal files.
.It Sq Li c
Toggle display of all files or
only directories which exist in both trees
and really different files.
.It Sq Li F
Toggle following symbolic links.
.It Sq Li p
Show current relative work directory.
.It Sq Li a
Show command line directory arguments.
.It Sq Li f
Show full path.
.It Dq Li <<
Copy from second to first tree.
(Does not follow symbolic links.)
.It Dq Li >>
Copy from first to second tree.
(Does not follow symbolic links.)
.It Dq Li dd
Delete file or directory, which must be present in one tree only.
(Does not follow symbolic links.)
.Nm
does not warn if a directory to delete is not empty.
.It Dq Li dl
Delete file or directory in first tree.
(Does not follow symbolic links.)
.It Dq Li dr
Delete file or directory in second tree.
(Does not follow symbolic links.)
.It Dq Li en
Rename file, which must be present in one tree only.
.It Dq Li eln
Rename file in first tree.
.It Dq Li ern
Rename file in second tree.
.It Dq Li ep
Change permissions of file, which must be present in one tree only.
.It Dq Li elp
Change permissions of file in first tree.
.It Dq Li erp
Change permissions of file in second tree.
.It Sq Li m
Mark file or directory.
This can be used to compare files or directories
which had been renamed or compressed in one file tree.
(Compressed directories can only be viewed.)
.It Sq Li r
Remove edit line or mark.
.It Sq Li y
Copy file path(s) to edit line.
If a
.Sq Li $
command is entered later, this file path can be used
to build a
.Xr sh 1
command.
.It Sq Li Y
Copy file paths to edit line in reverse order.
.It Sq Li $
Enter
.Xr sh 1
command.
If paths had been copied to the edit line before using the
.Sq Li y
or
.Sq Li Y
command, the shell command can be prepended by pressing
.Aq Cm HOME
and then entering the command.
Predefined strings can be inserted by pressing a
function key.
The work directory is the directory where
.Nm
had been started.
(If
.Fl B
or option
.Cm bmode
is used, the work directory is always the current view directory.)
Each entered command is saved in a history.
The keys
.Aq Cm UP
and
.Aq Cm DOWN
fetch other history entries.
.It Ao Cm F1 Ac \(en Aq Cm F12
Define string which can be inserted later with this function key
when entering a sh command using
.Sq Li $ .
This string is usually the name of a UNIX tool.
Regularly used strings can be set using the RC file
.Cm fkey
command.
.Pp
If the string begins with a
.Sq Li $
followed by at least one space
.Pq Sq Li " "
it is treated as shell command itself, which is
applied to a selected file.
If that function key is pressed later, a dialog opens
to ask if the command should be executed or the function
key should be redefined.
The filename is appended to the saved string.
To embed it,
.Dq Li $1
can be used, as in
.Dq Li "$ nroff $1 | less" .
.It Sq Li l
List strings which had been defined for a function key.
.It Sq Li u
Rebuild file list.
This may make sense after
.Sq Li /
did change the sorting order or after deleting or creating files using a
.Sq Li $
shell command.
.It Sq Li s
Open shell.
The shell to open is read from the users entry in
.Pa /etc/passwd .
.It Dq Li sl
Open shell in left directory tree.
.It Dq Li sr
Open shell in right directory tree.
.It Dq Li ol
Open left file or directory.
.It Dq Li or
Open right file or directory.
.It Sq Li \&:
Enter configuration option.
Entering
.Cm set
displays the current setting of the changable options.
Currently the options
.Po Cm no Pc Ns Cm ic ,
.Po Cm no Pc Ns Cm magic ,
and
.Po Cm no Pc Ns Cm ws
are supported.
.Pp
Previously entered options are saved in a history,
which can be accessed with the
.Aq Cm UP
and
.Aq Cm DOWN
keys.
.El
.Sh CONFIGURATION FILE ~/.vddiffrc
Permanent non-default options can be set in the file
.Pa ~/.vddiffrc .
The elements in this file may be separated with
spaces, tabs or line breaks.
Line breaks are not required, everything can be written
into one long line.
Also spaces or tabs are not required (outside quoted strings),
when every element is on it's own line.
Everything following a
.Sq Li #
(outside quoted strings)
to the end of the line is a comment.
.Bl -tag
.It Li difftool Ar string
Configure
.Ar string
as diff tool.
If
.Ar string
contains spaces it needs to be quoted with
.Sq Li \(dq
at begin and end.
The two filenames are appended to this string.
If the filenames need to be before a pipe symbol
.Pq Sq Li | ,
the symbols
.Dq Li $1
and
.Dq Li $2
can be embedded into
.Ar string
(in any order).
These symbols are expanded to the respective filename.
Since in this case the command is executed by
.Xr sh 1
instead of
.Xr execvp 3 ,
there are restrictions to the allowed characters
in filenames.
E.g. put
.Li $ Ns Ar n
in single quotes to allow filenames with spaces.
.Pp
Other possible diff tools are
.Xr colordiff 1 ,
.Xr mgdiff 1 ,
and
.Xr tkxcd 1 .
.It Li difftool bg Ar string
Start
.Ar string
as a background process (don't block
.Nm
while executing
.Ar string ) .
.Cm bg
is ignored if
.Ar string
contains
.Li $ Ns Ar n .
Put
.Sq Li &
at the end of
.Ar string
in this case.
.Cm bg
is also ignored if one of the files to be compared is compressed.
Since they are decompressed into a temporary directory
which is removed after starting the diff tool,
the file may be removed before the tool reads it.
.It Li viewtool Ar string
Configure
.Ar string
as view tool.
If
.Ar string
contains spaces it needs to be quoted with
.Sq Li \(dq
at begin and end.
The filename is appended to this string.
If the filename need to be before a pipe symbol
.Pq Sq Li |
the symbol
.Dq Li $1
can be embedded into
.Ar string ,
which is expanded to the filename.
.It Li viewtool bg Ar string
Start
.Ar string
as a background process.
.Cm bg
is ignored if
.Ar string
contains
.Li $ Ns Ar n .
Put
.Sq Li &
at the end of
.Ar string
in this case.
.Cm bg
is also ignored if the file to be viewed is compressed.
Since it is decompressed into a temporary directory
which is removed after starting the view tool,
the file may be removed before the tool reads it.)
.It Li ext Ar extension Ar string
Configure view tool
.Ar string
for filenames ending with
.Dq Li "." Ns Ar extension .
.Ar extension
is compared case-insensitive.
If
.Ar extension
is an integer number it needs to be enclosed
in double quotes
.Pq Sq \(dq
as in
.Pp
.Dl ext \(dq1\(dq \(dqtbl $1 | neqn | nroff -mandoc | less\(dq
.Pp
because the parser expects a string (and not a number)
after the keyword
.Li ext .
.It Li ext Ar extension Li bg Ar string
Start
.Ar string
as a background process.
.It Li skipext Ar extension
When checking a filename extension skip
.Ar extension
at the end of the filename.
E.g.
.Pp
.Dl skipext old
.Pp
would remove
.Dq Li .old
from the end of each filename before checking the
extension.
.It Li fkey Ar number Ar string
Define
.Ar string
which can be inserted later with this function key
when entering a sh command using
.Sq Li $ .
This string is usually the name of a UNIX tool.
.Ar number
must be between 1 and 12 (inclusive).
.Pp
If
.Ar string
begins with a
.Sq Li $
followed by at least one space (the string needs to be
enclosed in double quotes in this case),
it defines a shell command to be executed
for the selected file
when pressing the function key.
.It Li mono
Disable colors.
.It Li followlinks
Follow symbolic links.
(Note that the integrated file copy and delete operations
never follow symbolic links.)
.It Li noequal
Display differences only, hide equal files.
.It Li real_diff
Show only directories which exist in both trees
and really different files.
.It Li recursive
Recursively scan file tree to detect and mark
directories which contain differences.
This increases the start time.
To show only directories with differences
additinally set option
.Li real_diff .
To view all files when in this mode key
.Sq c
can be used.
.It Li noic
Searching for a filename with
.Sq Li /
or
.Dq Li //
is normally done case-insensitive.
Case-sensitive search can be configured with this option.
.It Li magic
For searching with
.Dq Li //
normally basic regular expressions are used.
Use of extended regular expressions is confgiured
with this option.
.It Li nows
Searching for a filename with
.Dq Li //
normally wraps around top and bottom of the file list.
This behaviour is disabled with this option.
.It Li filesfirst
Display directories at the end instead on top.
.It Li mixed
Display files and directories mixed.
.It Li dir_color Ar integer
Set color for directories.
Default is 3 (yellow).
.It Li diff_color Ar integer
Set color for different files.
Default is 1 (red).
.It Li link_color Ar integer
Set color for symbolic links.
Default is 5 (magenta).
.It Li left_color Ar integer
Set color for files found in first directory only.
Default is 6 (cyan).
.It Li right_color Ar integer
Set color for files found in second directory only.
Default is 2 (green).
.It Li unknown_color Ar integer
Set color for unknown file types.
Default is 4 (blue).
.It Li histsize Ar integer
Set shell command history size (command number) to
.Ar integer .
Default is 100.
A size less than 2 disables the history
(at least the current command line and one previous
entry need to be saved to use this feature).
.It Li scale
Show file size in human-readable format.
.It Li bmode
Debug option.
(If
.Nm
is started with only one or no argument
it behaves like a simple single directory view
file browser.)
.El
.Sh FILES
.Bl -tag -width ~/.vddiffrc -compact
.It Pa ~/.vddiffrc
Read on start-up to set non-default options.
.El
.\".Sh BUGS
.\"TODO issue:
.\"Pp
.\"Bl -bullet
.\"It
.\"El
